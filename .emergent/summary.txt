<analysis>
The AI engineer effectively managed the evolution of the KG Interiors application from dynamic category refactoring to the advanced Purchase Request system. Key achievements include the robust implementation of a CSV upload feature with client-side validation, versioning, and a centralized calculation utility. Database migrations were handled, and conflicting API routes were resolved. Following user feedback, the architecture for Purchase Requests shifted significantly, moving from a simple 1:1 item mapping to a complex junction table with weightage, reflecting a deep understanding of evolving requirements. The engineer demonstrated strong problem-solving in resolving database connection issues, managing conflicting file paths, and adapting to user-initiated code changes and  operations. The current focus is on completing the API layer for the redesigned Purchase Request feature, with UI development pending.
</analysis>

<product_requirements>
KG Interiors requires a finance management platform to replace Excel, providing real-time cash flow, commissions, and project financial health. The platform supports various workflows (Sales, Design, Shopping, Civil Vendor) and includes a Finance Dashboard, Project Ledger, Reports, and role-based access.

**Implemented features so far:**
*   Google OAuth for user authentication.
*   Customizable BizModel system with dynamic  (JSONB) for payment milestones and project stages, including discounts and Pay to vendor directly flags.
*   Project-specific  with approval workflow.
*   Advanced  calculations with dual-discount system.
*    storing category-wise totals in a  JSONB column.
*    page: Updated for dynamic rates and refactored to display items by dynamic categories.
*   Dynamic display of all configured categories and percentage payables per milestone in BizModel.
*    API and  UI refactored for dynamic categories.
*   All hardcoded category references removed.
*   **CSV Upload for Estimation Items:** Users can upload CSVs for estimations. The system processes and inserts items into  (new version) and . The original CSV is stored. Includes client-side validation and version management.
*   **Estimation Item Status:** A  column (, ) has been added to , defaulting to  on creation/upload.
*   **Purchase Requests (PRs) (Redesigned):** Allows creating PRs by linking  to  via a  junction table. This supports one estimation item breaking down into multiple PR items, with flexible quantities and component breakdown using . PR items no longer carry customer-facing pricing.
</product_requirements>

<key_technical_concepts>
-   **Full-stack:** Next.js (React frontend, API routes backend), PostgreSQL.
-   **Authentication:** NextAuth.js with Google OAuth.
-   **Styling:** Tailwind CSS and Shadcn UI components.
-   **Database:** Direct SQL queries via , custom migrations, JSONB, DB Transactions, composite unique constraints.
-   **CSV Processing:**  for client-side parsing,  for generation.
-   **Modularity:** Centralized calculation utilities ().
-   **Versioning:** Estimation item versioning, Git for code management.
</key_technical_concepts>

<code_architecture>


-   ****: Main database schema definition.
    -   **Summary:** Defines PostgreSQL schema. Continually updated to reflect new features.
    -   **Changes:**
        -    and  now have  JSONB.  has  JSONB.
        -    has  JSONB, .  removed.
        -    now includes a  column (VARCHAR, default 'Queued').
        -   New tables  and  created.
        -   :  removed (now in junction table), pricing columns removed,  is .
        -   New  junction table added.
-   ****: API for CSV uploads.
    -   **Summary:** Handles processing uploaded estimation item CSVs, inserting data into  and  within a DB transaction.
    -   **Changes:** Updated to use  for calculations and to set  from CSV or default to 'Queued'.
-   ****: API for CSV template download.
    -   **Summary:** Provides a CSV template for estimation item uploads.
    -   **Changes:** Updated to include the  column in the template.
-   ****: API for manual estimation item creation.
    -   **Summary:** Handles creating individual estimation items.
    -   **Changes:** Updated to set  to 'Queued' by default.
-   ****: **NEW** API for downloading a specific estimation version's CSV.
    -   **Summary:** Allows downloading an archived CSV for a given estimation version.
-   ****: **NEW** API for Purchase Request CRUD (list and create).
    -   **Summary:** Handles fetching all PRs for a project and creating new PRs based on the new architecture.
-   ****: **NEW** API for fetching estimation items available for PR creation.
    -   **Summary:** Returns estimation items along with their available quantities, considering quantities already linked in PRs.
    -   **Changes:** Modified to handle the new junction table based linking for calculating .
-   ****: **NEW** API for specific Purchase Request operations.
    -   **Summary:** Handles GET, PUT, DELETE for a single purchase request.
-   ****: Project detail page.
    -   **Summary:** Displays project info and estimation summary.
    -   **Changes:** Incorporated version management UI (dropdown to select versions, conditional visibility for Upload CSV and Edit Estimation buttons).  updated to include status column.
-   ****: Project estimation form.
    -   **Summary:** Critical for creating/modifying estimations.
    -   **Changes:** Refactored to use  for calculation functions.
-   ****: UI page for CSV upload.
    -   **Summary:** Provides an interface for users to upload estimation item CSVs, with client-side validation.
    -   **Changes:**  field name fixed to  (matching API), description updated. Validation updated to include  as an optional column with allowed values.
-   ****: Project-specific layout with navigation tabs.
    -   **Summary:** Provides layout and navigation for project sub-pages.
    -   **Changes:** Added a new tab for Purchase Requests.
-   ****: **NEW** UI page for listing Purchase Requests.
    -   **Summary:** Displays a table of Purchase Requests for the project.
    -   **Changes:** Initial page created, designed to list PRs in a table format.
-   ****: **NEW** UI page for creating Purchase Requests.
    -   **Summary:** Dedicated page for creating PRs, allowing users to select estimation items and define quantities/components.
    -   **Changes:** Initial page created, designed to display estimation items grouped by category in tables with quantity inputs.
-   ****: **NEW** UI page for viewing a specific Purchase Request.
    -   **Summary:** Dedicated page to view details of a single Purchase Request.
    -   **Changes:** Initial page created.
-   ****: Application constants.
    -   **Summary:** Centralizes static values.
    -   **Changes:** Added  constants (, ). Added  constants (, , ).
-   ****: **NEW** Calculation utility functions.
    -   **Summary:** Centralizes  and  for reuse across frontend and backend.
    -   **Changes:** Created this file and moved calculation logic into it.
-   ****: **NEW** Database migration.
    -   **Summary:** Adds the  column to the  table.
-   ****: **NEW** Database migration.
    -   **Summary:** Creates  and  tables.
    -   **Changes:** Modified to drop and recreate tables to fix previous  error.
-   ****: **NEW** Database migration.
    -   **Summary:** Modifies unique constraint on  to be composite (, ).
-   ****: **NEW** Database migration.
    -   **Summary:** Removes pricing-related columns from  and makes  .
-   ****: **NEW** Database migration.
    -   **Summary:** Implements the new junction table () architecture for PR items, and removes  from .
-   ****: Directory.
    -   **Summary:** Stores uploaded estimation CSV files.

</code_architecture>

<pending_tasks>
-   Complete the UI for the Create PR page () to allow users to select/define components and quantities with the new junction table architecture.
-   Implement the View PR page () to display PR details based on the new architecture.
-   Integrate validation in the PR creation UI (e.g., entered quantity <= available quantity).
-   Update PR financial summary displays based on vendor BOQ (future feature implied by removal of pricing columns from PR items).
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was implementing the  feature. The database schema for PRs has undergone several major architectural changes based on user feedback, moving from a simple 1:1 item mapping to a sophisticated component-based breakdown using a junction table.

**Current state:**
1.  **Constants:** New  constants (, , ) have been added to .
2.  **Database Migrations:**
    *    created initial PR tables.
    *    fixed the unique constraint on  to be composite (, ).
    *    removed pricing columns (, , , , , ) from  and made  .
    *    implemented the final, sophisticated architecture, creating the  junction table and removing the direct  from . All migrations have been successfully applied.
3.  **Schema Update:**  has been updated to reflect all the new tables and column changes.
4.  **API Routes:**
    *    (for listing and creating PRs) has been created.
    *    (for fetching estimation items available for PR creation with quantity tracking) has been updated to the new junction table architecture.
    *    (for single PR operations) has been created.
    *   The API implementation for the new Purchase Request architecture is confirmed as complete by the last AI message.
5.  **Frontend (Initial Structure):**
    *    has been updated to include a Purchase Requests navigation tab.
    *    (main PR listing page),  (dedicated PR creation page), and  (dedicated PR view page) have been created as placeholders based on the refined UX design.

The work paused after confirming that all necessary APIs for the redesigned Purchase Request feature have been implemented. The next phase is to build out the frontend components.
</current_work>

<optional_next_step>
Proceed with implementing the UI for the Purchase Request feature, starting with the .
</optional_next_step>
