<analysis>
The trajectory details a significant architectural refactoring of the KG Interiors application, primarily focused on the Estimation and Purchase Request (PR) modules. The work began with a request to fix a bug in the PR editing feature, specifically by removing a flawed soft-delete implementation (, ) in favor of a cleaner history-table approach.

This led to a series of user-driven architectural improvements. First, the concept of a  (a persistent UUID) was introduced to  to create a durable link between an estimation item and any PRs created from it, even across edits.

Subsequently, a major refactor of the estimation versioning system was undertaken. The initial model, which created a new version of the entire  record on every save, was deemed overly complex. It was replaced with a single estimation per project model. Now, editing an estimation moves the old items to an  table and inserts the updated items into the main  table, all within a single database transaction. This mirrors the pattern already established for PRs. The work involved extensive database migrations, backend API refactoring (especially ), and frontend updates to handle the new logic.

The user is technically proficient, providing precise file/line number references and architectural guidance. The final interaction before this summary was a request to apply the same history-table logic to the CSV upload feature for estimations, ensuring consistency across all edit paths.

The user's primary language is English. The next agent must respond in English.
</analysis>

<product_requirements>
The application, KG Interiors, requires a robust system for managing project Estimations and Purchase Requests (PRs). The initial system was functional but had architectural flaws that made it difficult to maintain and audit.

The core product goal evolved into creating a living document system for both Estimations and PRs, where edits are non-destructive and a full history is preserved.

**Key Requirements Implemented:**
1.  **Stable Item Identity**: Every item in an Estimation and a PR now has a  (UUID) that persists across all versions and edits, ensuring a stable reference point.
2.  **PR Versioning**: When a PR is edited, all its current items are moved to a history table, and the updated set of items is inserted as the new current version. This provides a complete, versioned audit trail for each PR.
3.  **Simplified Estimation Management**: The initial concept of multiple, versioned estimations per project was removed. Now, each project has only one canonical estimation. When this estimation is edited (either through the UI or a CSV upload), its items are versioned using a history table, but the parent estimation record remains singular.
</product_requirements>

<key_technical_concepts>
- **Backend**: Next.js API Routes.
- **Database**: PostgreSQL, with direct queries via the  library.
- **Database Schema Management**: Manual SQL migration scripts.
- **Versioning Architecture**: A Stable ID + History Table pattern. Edits move previous item states to a  table and insert the new state into the primary table.  links an item's lineage.
- **Transactional Integrity**: Critical database operations (like editing an estimation) are wrapped in , , and  blocks to ensure data consistency.
</key_technical_concepts>

<code_architecture>
The application follows a standard Next.js structure. The recent work has been concentrated on refactoring the estimation and purchase request modules, touching database migrations, backend APIs, and related frontend components.



- ****
    - **Importance**: These files document and apply the significant architectural shifts. They removed the old soft-delete and versioning columns (, ), introduced the  concept to estimations (, ), and created the history table (, ) that is central to the new single estimation model.
    - **Changes**: New migration files were created and executed to evolve the database schema to its current state.

- ****
    - **Importance**: This is the core backend endpoint for managing estimations. It now handles both creating a new estimation (POST) and updating the single existing one (PUT).
    - **Changes**: It was completely rewritten. The PUT handler now contains the transactional logic to: 1) move existing  to , 2) delete the old items, and 3) insert the new set of items from the payload, preserving  and original / values for existing items.

- ****
    - **Importance**: The primary frontend component for creating and editing a project estimation.
    - **Changes**: The submission logic () was updated to use a  request if an estimation already exists for the project, and a  otherwise. It was also updated to fetch and send the  for each item to facilitate the backend's versioning logic. The duplicate item action was fixed to not copy the .

- ****
    - **Importance**: Contains the versioning logic for Purchase Requests.
    - **Changes**: The logic was simplified by removing the  concept. It now only re-inserts items provided in the payload, implicitly deleting any that are omitted.

- **Multiple other files** (, , , etc.)
    - **Importance**: These files were connected to the old estimation versioning system.
    - **Changes**: They were all refactored to remove references to the now-deleted  and  columns in the  table, aligning them with the new one estimation per project architecture.
</code_architecture>

<pending_tasks>
- **CSV Upload Refactor**: The user has requested that the estimation CSV upload functionality be updated to use the same move to history and insert logic as the main edit/save flow. This is the immediate next task.
- **Vendor Communication**: Implement PDF download/email functionality for PRs.
- **Audit UI**: Build a UI to view the version history of a PR or an estimation's items.
- **Lifecycle Status Transitions**: Implement logic to change an item's .
</pending_tasks>

<current_work>
The AI engineer was in the process of analyzing the user's latest request. The user correctly identified an inconsistency: the Edit/Save Estimation flow in the UI correctly versions items by moving old ones to a history table, but the CSV Upload flow for estimations does not. The current upload logic was only partially updated and doesn't handle existing items correctly.

The user's request is to refactor  to align it with the new architecture. This involves:
1.  **Modifying the download template** () to include the  for existing items.
2.  **Updating the upload processing logic** () to:
    *   Read  from the uploaded CSV.
    *   Treat rows with a  as updates to existing items and rows without it as new items.
    *   Implement the same transactional move to history, then insert logic currently found in the main  PUT handler.

The previous engineer had just acknowledged the request and was starting the analysis phase, but had not yet proposed a concrete implementation plan.
</current_work>

<optional_next_step>
Analyze the  and  files and present a detailed approach to the user on how to implement the required changes, ensuring the CSV upload feature aligns with the established item versioning pattern.
</optional_next_step>
